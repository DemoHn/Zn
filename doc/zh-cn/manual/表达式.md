# 表达式

表达式是语句的一种特殊情况，亦即执行此段语句后能够得到结果值。举个例子，在语句 `令价格 = 2 + 3` 中，等号右边的 `2 + 3` 即是一个表达式，其对应的结果值是 `5`。本章将详细讲述 Zn 中支持的表达式的语法定义以及使用方法；

## 基础表达式

基础表达式是构成一个完整表达式的基本单元；在基础表达式之上还可以添加括号、花括号等词素 (token) 以构成更加复杂的表达式。在大部分情况下，基础表达式可以「独木成林」，亦即一个词素 (token) 即可构成一个表达式；基础表达式可分为以下几种类型：

**1. 作为变量名的标识符**

当一个标识符作为变量名使用时，它即代表了这个变量；同时这个表达式的结果值即是其对应变量的值。

比如事先定义一个名为「价格」的变量，并设置其值为数值 `19.9`；在语句 `（显示：价格）`中，冒号后面的 `价格` 标识符即作为变量名使用，其结果值亦是数值 `19.9`；而冒号前面的 `显示` 标识符作为方法名使用，因此 `显示` 在此处并非表达式。


**2. 数值及文本**

数值、文本皆为 Zn 的基本类型，同时它们也是一个单独的词素 (token)；程序在解析这些词素时会直接将它们当作一个表达式，其结果值即为此词素所代表的值；

如在语句 `（显示：125e-2）` 中，冒号后面的 `125e-2` 就是一个数值表达式，其值为 `1.25`，同理在语句 `（显示：「上是中国同」）` 中 `「上是中国同」` 是一个文本表达式，其值为文本 `上是中国同`，恰好五个中文字符。

> ✉️ 数值、文本的格式可以参见「文本结构」一章。

**3. 列表和字典**

列表 (list) 、字典 (dict) 亦是 Zn 的基本类型，但是在构成表达式时结构时稍显复杂一些；同理，表达式的结果值即是此元素所代表的值；

**列表表达式**的 BNF 语法如下所示：

```
‹列表表达式›   ::=  【  】
               |  【  ‹表达式›  [、  ‹表达式›]+  】
```

试举数例说明：

```zn
令空列表 =【】    注1：等号右边即是一个表达式，其值为「长度为0的空列表」
令十内质数列表 =【2、3、5、7】
令复合列表 = 【【“一”、“二”】、【“三”、“四”】】
```

**字典表达式**的 BNF 语法如下所示：

```
‹字典表达式›   ::=  【  =  】               
               |  【  ‹键值对›  [‹键值对›]+  】

‹键值对›      ::=  'ID  =  ‹表达式›
               |  '文本  =  ‹表达式›
               |  '数值  =  ‹表达式›
```

试举数例说明字典表达式：

```zn
令简码字典 =【
    G = “一”
    F = “地”
    D = “在”
    S = “要”
    A = “工”
】
令空字典 =【=】
令单行字典 = 【H = “上”，J = “是”，K = “中”，L = “国”，M = “同”】
```

你可能已经注意到，列表表达式和字典表达式的头尾词素都是`【` 和 `】`；因此从语法上区分这两者只能通过中间的内容，区分方法如下：

  - 如果中间没有内容，则判断它为 _空的列表_
  - 如果中间只有一个 `=`，则判断它为 _空的列表_
  - 如果中间有至少一个表达式，且表达式中存在 `=`，则优先按照 _字典表达式_ 匹配
    - 诸如 `【价格 = 3】`，会优先认为是 _字典表达式_ ，而不是一个包含了 `价格 = 3` 的赋值表达式的 _列表表达式_
  - 如果表达式之间用 `、` 分隔，则认定其为 _列表表达式_ ；_字典表达式_ 中每个键值对之间要么用换行符分隔，要么用 `，` 分隔
    - `【1、2、3】` 即是合法的 _列表表达式_ ，因为里面的各个表达式之间用 `、` 分隔
    - `【价格 = 3、数量 = 5】` 不是合法的语法，因为前面先当作 _字典表达式_ ，而后面又出现了顿号，因此是不符合语法要求的

## 用花括号组合

在某些情况下，我们希望程序能够优先执行某一部分组合，即使正常情况下它们是不会组合执行的；这个时候我们即可以在需要优先执行的组合前后加上一对花括号 `{` `}`；其 BNF 语法如下所示：

```zn
‹基础表达式›   ::=  {  ‹表达式›  }
```

举个简单的例子：我们都知道四则运算遵循「先乘除，后加减」的原则；Zn 也不例外，先算乘除法，再算加减法；因此表达式 ` 2 + 3 * 5` 的结果应是数值 `17`；而如果加上花括号，则表达式 `{2 + 3} * 5` 中优先执行花括号内的组合，得到 `5`，再进行乘法，得到结果 `25`。

## 方法调用

方法调用即是通过传入指定的参数和方法名称，执行方法内预先编写的逻辑，并得出相应的结果值。方法调用的形式非常灵活多样，如下所示：

**1. 直接调用方法**

直接调用方法的语法格式如下：

```
‹方法表达式'›   ::=  （  ‹方法名›  ）
                |  （  ‹方法名›  ：  ‹表达式›  [、  ‹表达式›]+  ）
```

> 和其他编程语言不同，这里的括号会把方法名以及对应参数全部包进去；这种设计主要出于分词考虑：如果像其他一样做成 `方法名（参数...）` 的话，一来格式上会产生疏离；二来方法名会和前面的对象产生混淆，造成无法分词的现象。

举个例子，假设我们事先设计了一个名为「求积」的方法，这个方法接受两个数值，并得到两者的乘积（亦即表达式的结果值为两者乘积）；现在要求 `4` 和 `9` 的乘积，就可以用 `（求积：4、9）` 来完成任务；

如果在调用某个方法时不需要传入参数，那么连冒号都可以不用了，直接在括号里写上方法名即可，如 `（结束循环）`。

**2. 调用变量对应的方法**

在 Zn 程序中，所有的变量值都属于 `元素` 类型，继而每一个变量都自带其对应的方法；这里的方法与面向对象语言中，对象的「方法」有异曲同工之妙。其语法格式如下：

```
‹方法表达式'›   ::=  以  ‹表达式›  （  ‹方法名›  ）
                |  以  ‹表达式›  （  ‹方法名›  ：  ‹表达式›  [、  ‹表达式›]+  ）
```

比如说我们要求「价格」变量向上取整之后的值，就可以这么写：`以价格（向上取整）`。

**3. 取得结果的两种形式**

在调用完方法后，下一步即是获取对应的结果。获取结果的第一种形式即是通过赋值语句将结果传给某个变量，比如 `结果 = （求积：4、9）`；第二种形式即是使用 `取得` 关键字，将结果传给 `取得` 后面的变量，其语法如下所示：

```
‹方法表达式›   ::=  ‹方法表达式'›  取得  'ID
```

这种语法设计的好处即是让语句更加通顺，更加符合中文自身的语法，试举数例：

```zn
以价格（向上取整），取得显示价格
（求积：4、9），取得结果
```

> 注1：这里的逗号 `，` 是可选项，可以加上也可以省略。  
> 注2：`取得` 关键词后的变量将会自动进行声明，再进行传值。 

**4. 方法的链式调用**

在调用变量对应的方法时，我们注意到 `以` 关键词后面也是个表达式；所以从理论上讲 `以以以以X（方法1）（方法2）（方法3）（方法4）` 这样令人诡异的表达式也是成立的。这个语句的具体执行逻辑是这样的：
  - 先执行 `以X（方法1）`，其结果假设为 `X1`
  - 将X1作为变量执行 `以X1（方法2）`，得到 `X2`
  - 将X2作为变量执行 `以X2（方法3）`，得到 `X3`
  - 将X3作为变量执行 `以X3（方法4）`，得到最终结果 `X4`

可以看到，这里看似俄罗斯套娃的语法实际上就是链式调用，上一个方法得到的值作为变量套到下一个方法中，最终得到结果。

为了简化理解，此处特地设计了一个链式调用的语法：

```
‹链式调用方法›   ::=  以  ‹表达式›  （  ‹方法名›  ：  ‹参数›  ） [、  （  ‹方法名›  ：  ‹参数›  ）]
```

因此，上面的语法即可改写成以下形式：

```zn
以X（方法1）、（方法2）、（方法3）、（方法4），取得X4
```

## 获取变量的属性

所有的变量都是对象，都有其对应的属性；我们可以通过对应的表达式获取变量的某个属性；获取属性的语法如下所示：

```
‹属性表达式›   ::=  ‹表达式›  [之  |  的]  'ID
```

同时，在部分确定上下文的情况下（比如说在 `定义` 语句下），我们可以用 `其` 关键字来指代某个

## 表达式的优先级