# 文本结构

本章主要介绍 Zn 语言的文本结构。Zn 程序在执行时，先经过 _分词器 (lexer)_ 将程序切割成 _语素 (token)_，而后再根据这些语素去完成后面的步骤。所以接下来的内容将主要介绍Zn 语言的文本特性及各个类型的语素，包括 _标识符 (identifier)_，_关键词 (keyword)_，_文本 (string)_，_数值 (number)_，_语句块 (block)_ 等。


## 文件及编码

Zn 程序一般以文件的形式存储。因为 Zn 程序采用 Unicode 编码解析，故文件须以 `UTF-8` 编码储存。采用其他编码（包括但不限于 `GB2312`, `Big5`, `GBK`等）存储的文件将会被认为是乱码，进而导致程序无法执行。

> ⚠️ 由于历史原因，Windows 系统在简体中文环境下的默认编码是 GBK，这导致了保存的文件一不小心就变成了GBK编码，从而导致程序解析失败。事实上，人们对“中文编程容易导致乱码”的刻板印象大多来自于此。
> 
> 解决问题的办法很简单：请使用专门的代码编辑器或者IDE去编辑程序文件！（现代的编辑器默认采用 UTF-8 编码）

文件名可以使用中文，对后缀名称并没有限制。不过为阅读方便，建议所有的Zn程序使用  `.zn` 作为后缀名。（如 `对象定义.zn`）


## 换行及缩进

Zn 程序是由一行行代码组成的。换行使得程序更加容易阅读，而且在很多情况下，完成一个语句必须需要换行。

Zn 支持以下四种 _换行符 (line break)_：`CRLF (U+000D U+000A)`，`LF (U+000A)`，`CR (U+000D)`，`LFCR (U+000A U+000D)`。一般在 Windows 下编写的文件采用 `CRLF`；而在 Linux 及 Mac 下编写的文件采用 `LF`。同一个文件下的换行符可以混用（虽然从实际角度不建议这么做），在空白行后面加换行符也是被允许的。

和 Python 类似，Zn 依赖 _缩进 (indent)_ 来标识不同层级的语句块。“缩进”一词最早来自于印刷行业，指的是在某行或某个段落前留上空白距离。而在 Zn 语言中，缩进将使用空白符来填充，并使用固定数量的空白符来表示一个单位缩进：一个单位缩进为 `4个空格 (U+0020)` 或者 `1个Tab (U+0009)` 字符。空格和Tab在同一个文件里不能混用，亦即若前一行以空格作为缩进符，则后一行不能以TAB作为缩进符。

> ✉️ 缩进值可以叠加，例如你可以在一行前面加上 12个空格 作为 缩进值为3；或者说是4个Tab 表示 缩进值为4。硬性规定4个空格做为单位缩进主要是以美观起见：毕竟在中文里空两格要比空一格好看不少。

如以下代码段所示：

```
如果程序为空：                    <--  第一行缩进值为0
    （显示：结果）                <--  前面有四个空格，缩进值为1
    每当结果大于0：
        （计算：“2+3”）          <--  前面有八个空格，缩进值为2
```

之后的章节会具体解释缩进的用途，此处先按下不表。

## 关键词及标识符

**关键词 (keyword)**

所谓关键词，即是指在程序中表达特定含义的词语。Zn语言的关键词由1~3个中文字符组成，目前一共有28个关键词，分别如下所示：

```
令      为      以     其      或      且      之
定义    如何    何为    恒为    是为     成为    不为
已知    返回    如果    再如    否则     每当    此之
遍历    等于    大于    小于    不等于   不大于   不小于
```

关键词的具体含义以及用法将在之后的章节陆续展开，此处先按下不表。

**标识符 (identifier)**

所谓标识符，即是指标识某个事物名称的词语。它可以代表 _变量名_，也可以代表 _属性名_、 _方法名_ 等。一个合法的标识符需要满足以下几个条件：

1. 标识符的长度至少为1个Unicode字符，长度上限为32个字符。

    > ✉️ 32个字符的限制也是为保证代码可读性而设，如果你发现连32个字符都不够用的话，是时候考虑换个名称了。

2. 标识符的第一个字符须满足以下Unicode编码范围之一：
    - `U+4E00 ~ U+9FEF` (中日韩统一表意文字 CJK Unified Ideographs)
    - `U+3007` (中文大写数字`〇`)
    - `U+0041 ~ U+005A` (大写英文字母 A-Z)
    - `U+0061 ~ U+007A` (小写英文字母 a-z)
    - `U+005F` (下划线符号 `_`)

3. 标识符其后的所有字符须满足以下Unicode编码范围之一：
    - 如 第2点 所述之范围（亦即满足第一个字符后，其后所有字符都满足）
    - `U+0030 ~ U+0039` (数字 0-9)
    - `U+002A` (符号 `*`)
    - `U+002B` (符号 `+`)
    - `U+002D` (符号 `-`)
    - `U+002F` (符号 `/`)    

按照上述规则，以下皆为合法的标识符：

```
I84
eventRuleList
公交车站-数目
_WINDOW_HANDLER2
MERS/SARS病例数
一九〇八-一九七八年项目变迁
```

**关键词与标识符之间的分隔**

鉴于中文不需要通过空格而分词的语法特性，Zn 采用“优先匹配关键词”的策略而不是根据空格分词。“优先匹配关键词”指即是指对于一串文本，优先提取其中的关键词，剩下的部分被当作是标识符来处理。比如 `李白之将军令为「朝辞白帝彩云间」`将会解析成所下所示的词素：

```
李白     <-- 标识符
之       <-- 关键词
将军     <-- 标识符
令       <-- 关键词
为       <-- 关键词
「朝辞白帝彩云间」   <-- 文本
```

这个策略能够成功去除对空格的依赖，但是同时也有一个副作用：在正常情况下 **一个标识符是没有办法包含关键词的**！如果需要这么做，即可在标识名的前后各加一个间隔号 （`·` U+00B7）。举个例子，若是希望将 `华为手机` 作为标识符（内含 `为` 关键词），即可通过加间隔号的方式变成 `·华为手机·`。

## 文本

文本 (string) 是 Zn 语言的一个重要组成结构，亦是一个基本类型。一个文本词素包含了数个 Unicode 字符，亦可不包含任何字符（下称 `空文本`）。文本词素的语法结构如下所示：

```
〔开引号〕 〔文本内容〕 〔闭引号〕 
```

中文的引号多是成双成对而存在的；在 Zn 语言中亦然。

目前 Zn 语言支持在文本中使用以下三种开引号作为文本的开始：`“` (英式双开引号)，`「` (中式单开引号)，`《` (双开书名号)。相对应的，以下三种闭引号须在文本结束时使用：`”` (英式双闭引号)，`」` (中式单闭引号)，`》` (双闭书名号)。

> ⚠️ 开引号须辅之以相对应的闭引号配对。如 `“` 和 `》` 是不能配对的。`“` 对应 `”`；`「` 对应 `」`；`《` 对应 `》`。

文本内容可以是任意 Unicode 字符，包括空格及换行符，甚至连引号本身都可以！
唯须注意：文本内容中的引号需要配对，不能单个存在。在此基础上所有的引号都不需要转义。

在文本内容中需要配对的引号如下所示：

| 引号名称 | 开引号字符 | 闭引号字符 |
|-----|:----:|:----:|
| 英式双引号| `“` | `”` |
| 中式双引号| `「` | `」` |
| 英式单引号| `‘` | `’` |
| 中式单引号| `『` | `』` |
| 双书名号| `《` | `》` |
| 单书名号| `〈` | `〉` |

以下例子皆是合法的文本：

1. 正常的单行文本
    ```
    「千里之行，始于足下。」
    ```    
    _开引号为`「`，文本内容为`千里之行，始于足下。`，闭引号为 `」`。_

2. 嵌套引号的文本

    ```
    《《论语》〈学而篇〉集注》
    ```
    _即使外层引号为`《》`，内层文本内容亦可包含`《》`，唯须注意文本内容里面的`《》〈〉`须配对。_

3. 多行文本

    ```
    “朝辞白帝彩云间，
    千里江陵一日还。
    两岸猿声啼不住，
    轻舟已过万重山。”
    ```

    _对于多行文本的处理和单行文本相同，换行符直接加上去就可以了。_

## 注释

注释 (comment) 用于解释某一个程序片段的逻辑以提高可读性。注释分两种： 单行注释及块注释。在程序的任何地方可以加上注释。

**单行注释**

单行注释的语法结构如下所示： `注〔?数字〕：〔注释内容〕` 。其中，`注` 是一个关键字（虽然没有在正式的关键字列表中）；以 `注` 字开头，再加上一个冒号（`：` U+FF1A），当前行后面所有内容都是注释的一部分。值得注意的是，在注释内容中不能添加任何换行符，否则只有换行符前的内容才会被当作注释，换行符之后的内容不被视作注释的一部分。

在 `注` 字后面加上任意个数的 `0~9` 之间的数字都是可以的，比如 `注12：`。数字并没有特别的含义，纯粹只是供阅读者标记方便之用。

**块注释**

块注释的语法结构与单行注释稍有不同：`注〔?数字〕：「〔注释内容〕」` 或 `注〔?数字〕：“〔注释内容〕」”` 。和单行注释相比，块注释会在注释内容前后加上双引号，以此表示里面的内容是注释。和文本相同，注释内容可以是多行，其内容亦可以是任何 Unicode 字符（包括 `注` 字）。唯须注意：注释内容里若包含引号，引号也同样需要配对。

以下为合法注释的几个例子：

1. 在正常代码后面加上单行注释
    ```     
    如果其名为「小明」：  注1：此行的「为」字并非代表赋值，而是作逻辑判断用。
        （显示：「小明的成绩」）
    ```

2. 多行注释
    ```
    注：「
    此方法主要用于计算当前商品的总价。
    参数1：商品SKU ID
    参数2：商品数量
    参数3：商品折扣
    返回值：商品总价
    」
    ```

## 数值

数值 (number) 用于代表一个确定的整数或小数。数值只支持用阿拉伯数字 (0~9) 以及小数点等符号表示，不支持中文数字。其参考正则表达式如下所示：

```
[-+]?[0-9]*\.?[0-9]+((([eE][-+])|(\*(10)?\^[-+]?))[0-9]+)?
```

简单来说，数值的表示可以分成三类：

1. 整数

    整数包括正整数及负整数。如要表示负整数，即在数字前加 `-` 号即可。如 `125`，`-87`，`+68`。

2. 小数

    小数和日常表示方法一致，都是在数字中间加小数点(`.` U+002E)，注意在小数点前不加任何数字也是可以的（即 `.xxx ⟺ 0.xxx`）。如 `2.5`，`.003`，`-0.732`。

3. 科学计数法

    科学计数法可以方便地表示一个非常大或者非常小的数值（比如说 `1000000000` 这种），其基本原理是在前面用一个小数 _a_ 来表示 (`1 <= |a| < 10`)，后面再跟上指数幂 _n_。其最终值为 _a × 10<sup>n</sup>_。

    目前支持四种写法：`〔a〕*10^〔n〕`，`〔a〕*^〔n〕`，`〔a〕e[+-]〔n〕`及`〔a〕E[+-]〔n〕`。如 `1.25*10^8`，`6.02E+23`，`1.602e-19`。

为了阅读方便，可以在数字与数字 _之间_ 的任何位置添加 `_` 表示分隔，比如 `1_000_000_000`，其效果等同于 `1000000000`。

以下数值皆是有效的：

|  数值 |  备注  |
| ------ | --------- |
| 123456 | 正常整数 |
| -12345 | 前导 - 号 |
| +12345 | 前导 + 号 |
| .12 | 等同于 0.12|
| 0.000 | |
| 0129.8 | 数值前可以加0 |
| 1.0000 | | 
| -18.9E-7 | |
| -18.9E+27 | 幂后面的系数前面一定要跟 + 号 |
| -18.9e+27 | 中间的 E 也可以是小写 |
| 125*10^12 | 中间只能写 `*10^`，`*9^` 是不支持的 |
| 125*^12 | 可以省略 `10` |

以下情况下会无法解析：

| 数值 | 错误原因 |
| ------ | ------------- |
| 0xEF | 目前还不支持16进制字符的表示 |
| 34. | 小数点后需要跟数字 |
| 23..3 | 多个小数点 |
| 132 3456 | 数字之间不能有空格 |
| 125*8^2 | 只支持 `*10^` |
| 128E923| 幂值部分需要加前导符号 `+` 或者 `-` |
| --123 | 前导符号只能有一个 |

## 定界符

定界符 (delimiter) 用于标识特定语法。目前所有的定界符如下所示：

```
，      ：      ；      ？      &       ！
@       #       …      =      【       】
（      ）      {       }      ⟺
```
_（具体 Unicode 编码信息参见附录）_

> ✉️ `！ & @ …` 目前暂时没有用到，留待后续设计使用。

> ⚠️ 虽然 Zn 语言的定界符经过精心设计，保证在中文输入法下能够用键盘直接打出；但是在实际使用仍需要注意 `全形` (fullwidth) 和 `半形` (halfwidth) 的区别。
>
> `！ ？ ； ： ，` 都是全形字符，注意和对应的 `! ? ; : ,` 半形字符作区分。
>
> 同样的，`# @ & =` 在中英文输入法下都是半形字符，注意不要误输入对应的全形字符 `＃ ＠ ＆ ＝`。

#### 附录A：代码文本解析优先级

对于同一个片段，会因为处于不同的语素中而展现出不同的意义。比如 `「命令」` 一词，正常应作为文本处理，而若是在注释区块中即代表注释内容的一部分。下表展现出文本解析优先级：

> 优先级别数字越大，优先级越高；若是高优先级内容（例如注释）包含了低优先级的内容（例如文本），则低优先级的内容将被视作高优先级内容的一部分。

| 优先级别 | 语素名称 | 示例 |
|----|----|----|
| 5 | 注释 | `注：「这个「·华为手机·」是注释」`|
| 4 | 文本 | `「这是一个·华为手机·」`|
| 3 | 标注标识符 | `·华为手机·`|
| 2 | 关键字 | `为` |
| 1 | 标识符 | `手机`|

#### 附录B：关键字符之Unicode码表

| 关键字符 | Unicode编码 |  备注 |
| :-----: | :--------: |  ---- |
| 不      |  	U+4E0D |       |
| 且      |  	U+4E14 |       |
| 为      |  	U+4E3A |       |
| 义      |  	U+4E49 |       |
| 之      |  	U+4E4B |       |
| 于      |  	U+4E8E |       |
| 令      |  	U+4EE4 |       |
| 以      |  	U+4EE5 |       |
| 何      |  	U+4F55 |       |
| 其      |  	U+5176 |       |
| 再      |  	U+518D |       |
| 则      |  	U+5219 |       |
| 历      |  	U+5386 |       |
| 否      |  	U+5426 |       |
| 回      |  	U+56DE |       |
| 大      |  	U+5927 |       |
| 如      |  	U+5982 |       |
| 定      |  	U+5B9A |       |
| 小      |  	U+5C0F |       |
| 已      |  	U+5DF2 |       |
| 当      |  	U+5F53 |       |
| 恒      |  	U+6052 |       |
| 成      |  	U+6210 |       |
| 或      |  	U+6216 |       |
| 是      |  	U+662F |       |
| 果      |  	U+679C |       |
| 此      |  	U+6B64 |       |
| 每      |  	U+6BCF |       |
| 注      |  	U+6CE8 |       |
| 知      |  	U+77E5 |       |
| 等      |  	U+7B49 |       |
| 返      |  	U+8FD4 |       |
| 遍      |  	U+904D |       |
| 《      |  	U+300A |       |
| 》      |  	U+300B |       |
| 〈      |  	U+27E8 |       |
| 〉      |  	U+27E9 |       |
| 「      |  	U+300C | 中式单开引号 |
| 」      |  	U+300D | 中式单闭引号 |
| 『      |  	U+300E | 中式双开引号 |
| 』      |  	U+300F | 中式双闭引号 |
| “      |  	U+201C | 英式双开引号 |
| ”      |  	U+201D | 英式双闭引号 |
| ‘      |  	U+2018 | 英式单开引号 |
| ’      |  	U+2019 | 英式单闭引号 |